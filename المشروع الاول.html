<!DOCTYPE html>
<html>
<head>
  <title>ElevenLabs Text to Speech</title>
  <style>
    body { font-family: sans-serif; }
    #container { width: 80%; margin: 20px auto; }
    input[type="text"] { width: 100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box; }
    button { padding: 10px 20px; cursor: pointer; }
    audio { width: 100%; margin-top: 10px; }
  </style>
</head>
<body>
  <div id="container">
    <h1>ElevenLabs Text to Speech (Beta)</h1>
    <input type="text" id="textToSpeak" placeholder="أدخل النص هنا">
    <button onclick="convertToSpeech()">تحويل إلى كلام</button>
    <audio id="audioPlayer" controls style="display: none;"></audio>
    <p id="status"></p>
  </div>

  <script>
    const apiKey = "a57b8e91c3a5ef000619cd9f910f4be7";
    const apiUrl = "https://ct-api.wondershare.cc/v2/ctsrv/relay_app";
    const voiceCode = "NAiu3tJ5aIt0mMkYudaH"; // رمز الصوت المحدد
    const headersBase = {
      "User-Agent": "com.wondershare.filmorago13861",
      "Accept-Encoding": "gzip",
      "Content-Type": "application/json",
      "x-client-type": "4",
      "x-prod-id": "1937",
      "x-prod-ver": "13.8.61",
      "x-plat-id": "1937",
      "x-prod-name": "FilmoraV13_Android",
      "x-ver": "",
      "x-lang": "ar-ae",
      "authorization": "Bearer 0YQXwi3omSHeOVjAz_G-a0w",
      "x-user-type": "1937",
      "x-app-key": apiKey
    };

    async function doPost(url, payload, headers) {
      try {
        const response = await fetch(url, {
          method: "POST",
          headers: headers,
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP error! status: ${response.status}, body: ${errorText}`);
        }

        return await response.json();
      } catch (error) {
        console.error("Error in doPost:", error);
        document.getElementById("status").innerText = `حدث خطأ: ${error.message}`;
        return null;
      }
    }

    async function convertToSpeech() {
      const text = document.getElementById("textToSpeak").value;
      if (!text) {
        document.getElementById("status").innerText = "الرجاء إدخال نص.";
        return;
      }
      document.getElementById("status").innerText = "جاري التحويل...";

      const payload1 = {
        lang_code: "en-US",
        model_id: "eleven_multilingual_v2",
        pitch_rate: 0,
        platform_id: 10,
        speech_rate: 0,
        task_contents: [{ sentence: text, task_index: 1 }],
        url_alias: "v5_voice_tts_internal_transfer_no_consume",
        ver: 2,
        voice_code: voiceCode,
        volume: 0
      };

      const headers1 = {
        ...headersBase,
        "x-client-sn": "90cd7ace8c50c6c36b5d68ca79c4b8a0", // قد تحتاج لتغيير هذا
        "x-timestamp": Date.now().toString(),
        "x-signature": "5d385b595ea48900dff6beda821fac1976d80d7a345403e07ef65dacd9b4c9cb" // قد تحتاج لتغيير هذا
      };

      const response1 = await doPost(apiUrl, payload1, headers1);

      if (response1 && response1.data && response1.data.task_id) {
        const taskId = response1.data.task_id;
        document.getElementById("status").innerText = `تم إنشاء المهمة بنجاح، المعرف: ${taskId}. جاري التحقق من حالة الصوت...`;

        const getResultUrl = apiUrl;
        const payload2 = {
          task_id: taskId,
          url_alias: "v5_voice_tts_internal_result_task_id_no_consume"
        };
        const headers2 = {
          ...headersBase,
          "x-signature": "8f655cf737ec6a1c72c1e18e247136f2fa8f1f2f849f676ed5b8b59c9df9cc6d", // قد تحتاج لتغيير هذا
          "x-timestamp": (Date.now() + 7644).toString() // إضافة فرق الوقت كما في الكود الأصلي
        };

        let checkCount = 0;
        const maxChecks = 30; // عدد مرات التحقق القصوى
        const checkInterval = 2000; // الفاصل الزمني للتحقق بالمللي ثانية

        const checkTaskStatus = () => {
          if (checkCount >= maxChecks) {
            document.getElementById("status").innerText = "فشل في الحصول على رابط الصوت بعد عدة محاولات.";
            return;
          }

          setTimeout(async () => {
            const response2 = await doPost(getResultUrl, payload2, headers2);
            if (response2 && response2.data && response2.data.status) {
              const status = response2.data.status;
              if (status === 1) {
                const downloadUrl = response2.data.list && response2.data.list[1] && response2.data.list[1].download_url;
                if (downloadUrl) {
                  document.getElementById("audioPlayer").src = downloadUrl;
                  document.getElementById("audioPlayer").style.display = "block";
                  document.getElementById("status").innerText = "تم الحصول على الصوت بنجاح.";
                } else {
                  document.getElementById("status").innerText = "فشل في العثور على رابط التحميل.";
                }
              } else if (status === 2) {
                document.getElementById("status").innerText = `جاري المعالجة... (المحاولة ${checkCount + 1})`;
                checkCount++;
                checkTaskStatus();
              } else {
                document.getElementById("status").innerText = `حدث خطأ أثناء التحميل! الحالة: ${status}`;
              }
            } else {
              document.getElementById("status").innerText = "حدث خطأ أثناء التحقق من حالة المهمة.";
            }
          }, checkInterval);
        };

        checkTaskStatus();

      } else {
        document.getElementById("status").innerText = "فشل في إنشاء المهمة.";
      }
    }
  </script>
</body>
</html>